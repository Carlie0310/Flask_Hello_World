# .github/workflows/atelier3.yml
name: ATELIER 3 – Serveur Flask + ngrok

on:
  workflow_dispatch:

jobs:
  deploy-flask-via-ngrok:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du dépôt
        uses: actions/checkout@v3

      - name: Build de l’image Docker
        run: |
          docker build -t flask-hello-world .

      - name: Lancer le conteneur Flask
        run: |
          docker run -d --name flask_container -p 5000:5000 flask-hello-world

      - name: Installer ngrok
        run: |
          wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
          unzip ngrok-stable-linux-amd64.zip
          chmod +x ./ngrok

      - name: Auth ngrok
        run: |
          ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Démarrer ngrok et récupérer l’URL
        id: start_ngrok
        run: |
          nohup ./ngrok http 5000 --log=stdout > ngrok.log 2>&1 &
          sleep 5
          NGROK_URL=$(grep -oE "https://[0-9a-z]+\\.ngrok\\.io" ngrok.log | head -n1)
          echo "URL_NGROK=$NGROK_URL" >> $GITHUB_OUTPUT

      - name: Afficher l’URL ngrok
        run: |
          echo "Votre serveur Flask est exposé temporairement à : ${{ steps.start_ngrok.outputs.URL_NGROK }}"

      - name: Garder le tunnel actif (120 s)
        run: |
          echo "Tunnel actif pendant 120 secondes…"
          sleep 120
          echo "Fin du tunnel. Le job va se terminer."
