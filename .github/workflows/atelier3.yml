# .github/workflows/atelier3.yml
name: ATELIER 3 – Serveur Flask + ngrok

on:
  workflow_dispatch:

jobs:
  deploy-flask-via-ngrok:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout du dépôt
      - name: Checkout du dépôt
        uses: actions/checkout@v3

      # 2. Build de l'image Docker
      - name: Build de l’image Docker
        run: |
          docker build -t flask-hello-world .

      # 3. Lancer le conteneur Flask
      - name: Lancer le conteneur Flask
        run: |
          docker run -d --name flask_container -p 5000:5000 flask-hello-world

      # 4. Télécharger et installer ngrok, puis installer jq (avec sudo)
      - name: Installer ngrok et jq
        run: |
          wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
          unzip ngrok-stable-linux-amd64.zip
          chmod +x ./ngrok
          # Mettre à jour la liste des paquets et installer jq
          sudo apt-get update
          sudo apt-get install -y jq

      # 5. (Optionnel) Auth ngrok si vous avez configuré un token dans les Secrets GitHub
      # - name: Auth ngrok
      #   run: |
      #     ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      # 6. Démarrer ngrok en tâche de fond
      - name: Démarrer ngrok en tâche de fond
        run: |
          nohup ./ngrok http 5000 --log=stdout > ngrok.log 2>&1 &
          # Laisser ngrok démarrer
          sleep 5

      # 7. Interroger l’API locale de ngrok pour récupérer l’URL publique
      - name: Récupérer l’URL publique ngrok
        id: get_ngrok_url
        run: |
          RESPONSE=$(curl --silent http://127.0.0.1:4040/api/tunnels)
          PUBLIC_URL=$(echo "$RESPONSE" | jq -r '.tunnels[0].public_url')
          if [ -z "$PUBLIC_URL" ] || [ "$PUBLIC_URL" == "null" ]; then
            echo "ERREUR : impossible de récupérer l’URL ngrok."
            echo "Contenu de la réponse API ngrok : $RESPONSE"
            exit 1
          fi
          echo "URL_NGROK=$PUBLIC_URL" >> $GITHUB_OUTPUT

      # 8. Afficher l’URL ngrok dans les logs
      - name: Afficher l’URL ngrok
        run: |
          echo "Votre serveur Flask est exposé temporairement à : ${{ steps.get_ngrok_url.outputs.URL_NGROK }}"

      # 9. Garder le tunnel actif pendant 120 secondes
      - name: Garder le tunnel actif (120 s)
        run: |
          echo "Tunnel actif pendant 120 secondes…"
          sleep 120
          echo "Fin du tunnel. Le job se termine."
